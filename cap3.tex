  \label{chap:cap3}

  \chapter {Implementaci\'{o}n de la soluci\'{o}n}

    \section {Configuraci\'{o}n del sistema operativo}

El sistema operativo que ser\'{a} utilizado para la implementaci\'{o}n es \textsc{Debian GNU/Linux} 7.0 \textit{\guillemotleft wheezy\guillemotright} que se instalar\'{a} de manera nativa en el servidor y se le aplicar\'{a}n configuraciones personalizadas para ejecutar el software que ser\'{a} implementado, ajustar el rendimiento y reforzar la seguridad de los servicios que ofrezca.

      \subsection {Arreglo de discos RAID}

Los discos duros del servidor ser\'{a}n configurados en un arreglo RAID debido a las ventajas que propone para el servicio\footnote{Ver p\'{a}gina \pageref{Arreglos-RAID} secci\'{o}n \ref{Arreglos-RAID}}. La configuraci\'{o}n en el servidor de pruebas se realizar\'{a} con un arreglo RAID [] por \textit{software}, mientras que en el servidor de producci\'{o}n se realizar\'{a} en un arreglo por \textit{hardware}.

Para realizar la configuraci\'{o}n de un arreglo RAID 1 por software se realiza lo siguiente: \footnote{https://wiki.debian.org/SoftwareRAID}

\begin{itemize}
  \item Instalar el software para el arreglo por software
    \code{\# apt-get install mdadm}
  \item Crear las particiones de tipo \textit{Linux RAID Autodetect} en cada disco del arreglo
    \begin{itemize}
      \item Crear una partici\'{o}n primaria que ocupe todo el espacio del disco:

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # /sbin/fdisk /dev/sdb

    Device contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel
    Building a new DOS disklabel with disk identifier 0x00bab10c.
    Changes will remain in memory only, until you decide to write them.
    After that, of course, the previous content won't be recoverable.
    
    Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)
    
    Command (m for help): n
    Partition type:
       p   primary (0 primary, 0 extended, 4 free)
       e   extended
    Select (default p): p
    Partition number (1-4, default 1): 1
    First sector (2048-16777215, default 2048): 
    Using default value 2048
    Last sector, +sectors or +size{K,M,G} (2048-16777215, default 16777215): 
    Using default value 16777215
\end{verbatim}
}

      \item Cambiar el tipo de la partici\'{o}n a \texttt{0xfd} - \textit{Linux RAID Autodetect} y escribir la tabla de particiones al disco:

{
\scriptsize
\linespread{1}
\begin{verbatim}
    Command (m for help): t
    Selected partition 1
    Hex code (type L to list codes): fd
    Changed system type of partition 1 to fd (Linux raid autodetect)
    
    Command (m for help): w
    The partition table has been altered!
    
    Calling ioctl() to re-read partition table.
    Syncing disks.
\end{verbatim}
}

    \end{itemize}
  \item Crear arreglo
    \code{\# mdadm --zero-superblock /dev/sdb1 /dev/sdc1}
    \code{\# mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sdb1 /dev/sdc1}
  \item Formatear
    \code{\# mkfs.ext4 /dev/md0}
  \item Asignar tipo y punto de montaje en \texttt{/etc/fstab}
    \code{/dev/md0 /home ext4 noatime,rw 0 0}
  \item Guardar configuraci\'{o}n en el archivo \texttt{/etc/mdadm/mdadm.conf}
    \code{ARRAY /dev/md0 devices=/dev/sdb1,/dev/sdc1 level=1 num-devices=2 auto=yes}
    \code{DEVICE /dev/sdb1 /dev/sdc1}
\end{itemize}

      \subsection {Reducci\'{o}n de componentes instalados}

Como parte de la configuraci\'{o}n de seguridad, es recomendable minimizar los paquetes que se instalan en el sistema operativo para disminuir la ventana de posibilidades de tener una intrusi\'{o}n. Con la siguiente configuraci\'{o}n se guardan en disco \'{u}nicamente las paginas de manual en ingles y se evita la instalacion de paquetes no esenciales del sistema operativo \footnote{http://aptitude.alioth.debian.org/doc/en/ch02s05s05.html}

{
\scriptsize
\linespread{1}
\begin{verbatim}
  # aptitude install localepurge
  en_US.utf-8
  echo 'Apt::Install-Recommends "false"' > /etc/apt/apt.conf.d/10Install-Recommends
\end{verbatim}
}

    \section {Configuraci\'{o}n de las herramientas}

      \subsection {OpenSSH}

Para la configuraci\'{o}n del servicio de \textsc{SSH} se aplicaron las siguientes opciones:

\begin{itemize}
  \item Restringir el acceso administrativo directo \'{u}nicamente mediante autenticaci\'{o}n de llave p\'{u}blica.
    \code{PermitRootLogin without-password}
  \item Deshabilitar el acceso a cuentas que tengan una contrase\~{n}a vac\'{i}a.
    \code{PermitEmptyPasswords no}
  \item Permitir el acceso al grupo de usuarios de la \textit{Unidad de C\'{o}mputo} de la \textsc{DICyG}.
    \code{AllowGroups adm staff support}
  \item  Mostrar una pantalla antes de iniciar la sesi\'{o}n en la que se listen las pol\'{i}ticas de uso del sistema.
    \code{Banner /etc/issue.net}
  \item Evitar la desconexi\'{o}n manteniendo actividad en la sesi\'{o}n.
    \code{TCPKeepAlive yes}
    \code{ClientAliveInterval 30}
  \item Evitar la redirecci\'{o}n de puertos y sesiones gr\'{a}ficas.
    \code{AllowTCPForwarding no}
    \code{GatewayPorts no}
    \code{X11Forwarding no}
  \item Desconectar al usuario si no inicia sesi\'{o}n en 60 segundos.
    \code{LoginGraceTime 60}
\end{itemize}

      \subsection {OpenLDAP}

          \subsubsection {Instalaci\'{o}n de \textsc{OpenLDAP}}

Se instala \textsc{OpenLDAP} utilizando el comando aptitude, es necesario contestar \textbf{NO} en el cuadro de di\'{a}logo para seguir el asistente de instalaci\'{o}n:

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # aptitude install slapd
\end{verbatim}
}


{
\scriptsize
\linespread{1}
\begin{verbatim}
+---------------------------+ Configuring slapd +----------------------------+
| If you enable this option, no initial configuration or database will be    |
| created for you.                                                           |
|                                                                            |
| Omit OpenLDAP server configuration?                                        |
|                    <Yes>                       <No>                        |
+----------------------------------------------------------------------------+
\end{verbatim}
}

Se pide el nombre DNS del dominio que servir\'{a} para conformar la ra\'{i}z del \'{a}rbol de \textsc{LDAP}.

{
\scriptsize
\linespread{1}
\begin{verbatim}
+---------------------------+ Configuring slapd +----------------------------+
| The DNS domain name is used to construct the base DN of the LDAP           |
| directory. For example, 'foo.example.org' will create the directory with   |
| 'dc=foo, dc=example, dc=org' as base DN.                                   |
|                                                                            |
| DNS domain name:                                                           |
| xnas.local________________________________________________________________ |
|                                   <Ok>                                     |
+----------------------------------------------------------------------------+
\end{verbatim}
}

Adicionalmente el instalador pregunta por el nombre de la organizaci\'{o}n, aunque este dato no es necesario, se recomienda introducirlo:

{
\scriptsize
\linespread{1}
\begin{verbatim}
+---------------------------+ Configuring slapd +----------------------------+
| Please enter the name of the organization to use in the base DN of your    |
| LDAP directory.                                                            |
|                                                                            |
| Organization name:                                                         |
| xNAS_____________________________________________________________________  |
|                                  <Ok>                                      |
+----------------------------------------------------------------------------+
\end{verbatim}
}

A continuaci\'{o}n se pide que se introduzca la contrase\~{n}a que ser\'{a} utilizada por el administrador del directorio:

{
\scriptsize
\linespread{1}
\begin{verbatim}
+-------------------------+ Configuring slapd +------------------------------+
| Please enter the password for the admin entry in your LDAP directory.      |
|                                                                            |
| Administrator password:                                                    |
| **********____________________________________________________________     |
|                                 <Ok>                                       |
+----------------------------------------------------------------------------+

+---------------------------+ Configuring slapd +----------------------------+
| Please enter the admin password for your LDAP directory again to verify    |
| that you have typed it correctly.                                          |
|                                                                            |
| Confirm password:                                                          |
| **********_______________________________________________________________  |
|                                  <Ok>                                      |
+----------------------------------------------------------------------------+
\end{verbatim}
}

Se recomienda deshabilitar el soporte del protocolo \textsc{LDAPv2} puesto que es obsoleta, responder \textbf{NO} en el cuadro de di\'{a}logo.

{
\scriptsize
\linespread{1}
\begin{verbatim}
+----------------------------+ Configuring slapd +---------------------------+
|                                                                            |
| The obsolete LDAPv2 protocol is disabled by default in slapd. Programs and |
| users should upgrade to LDAPv3.  If you have old programs which can't use  |
| LDAPv3, you should select this option and 'allow bind_v2' will be added to |
| your slapd.conf file.                                                      |
|                                                                            |
| Allow LDAPv2 protocol?                                                     |
|                     <Yes>                        <No>                      |
+----------------------------------------------------------------------------+
\end{verbatim}
}

          \subsubsection {Configuraci\'{o}n de \textsc{OpenLDAP}}

Se configur\'{o} el sistema operativo para permitir que los usuarios de \textsc{LDAP} de tipo \textit{posixAccount} puedan iniciar sesi\'{o}n en el equipo.

{
\scriptsize
\linespread{1}
\begin{verbatim}
  # aptitude install libpam-ldapd
\end{verbatim}
}

Adicionalmente se instalaron los demonios \textsc{NSCD} y \textsc{NSLCD} que se utilizan para guardar en \textit{cache} los resultados de las consultas al directorio y para representar los objetos \textit{posixAccount} de \textsc{LDAP} como cuentas est\'{a}ndar de \textsc{UNIX}.

%\ifdraft{Configuraci\'{o}n de \textsc{OpenLDAP}.}{\verbatimincludebox{./etc/ldap/ldap.conf}}

{
\scriptsize
\linespread{1}
\begin{verbatim}
+------------------------+ Configuring libnss-ldapd +-------------------------+
| For this package to work, you need to modify your /etc/nsswitch.conf to     |
| use the ldap datasource.                                                    |
|                                                                             |
| You can select the services that should have LDAP lookups enabled. The new  |
| LDAP lookups will be added as the last datasource. Be sure to review these  |
| changes.                                                                    |
|                                                                             |
| Name services to configure:                                                 |
|    [*] group                                                                |
|    [*] passwd                                                               |
|    [*] shadow                                                               |
|                                   <Ok>                                      |
+-----------------------------------------------------------------------------+
\end{verbatim}
}

Para la configuraci\'{o}n de \textsc{PAM}, se indica que se utilizar\'{a}n como fuentes de autenticaci\'{o}n la base de datos est\'{a}ndar de UNIX y adicionalmente el directorio LDAP.

{
\scriptsize
\linespread{1}
\begin{verbatim}
+----------------------------+ PAM configuration +----------------------------+
| Pluggable Authentication Modules (PAM) determine how authentication,        |
| authorization, and password changing are handled on the system, as well as  |
| allowing configuration of additional actions to take when starting user     |
| sessions.                                                                   |
|                                                                             |
| Some PAM module packages provide profiles that can be used to               |
| automatically adjust the behavior of all PAM-using applications on the      |
| system.  Please indicate which of these behaviors you wish to enable.       |
|                                                                             |
| PAM profiles to enable:                                                     |
|    [*] Unix authentication                                                  |
|    [*] LDAP Authentication                                                  |
|                    <Ok>                        <Cancel>                     |
+-----------------------------------------------------------------------------+
\end{verbatim}
}

          \subsubsection {Inicializaci\'{o}n del directorio \textsc{LDAP}}

Una vez instalado el servicio de directorio, es necesario inicializar la estructura b\'{a}sica que comprende los contenedores de usuarios, materias y grupos. % mencionados en \cite{}... \ref{}...

{
\scriptsize
\linespread{1}
\begin{verbatim}
  # ldapadd -Y external ... < xNAS-base.ldif
  + users
  +   staff
  +   profesores
  +   alumnos
  + grupos
  + materias
\end{verbatim}
}

          \subsubsection {Carga de datos en el directorio \textsc{LDAP}}

Para realizar la carga de la base de datos de materias, profesores, alumnos y grupos se desarroll\'{o} un programa en el lenguaje de programaci\'{o}n \textsl{Ruby} que lee los datos desde un archivo origen en formato \texttt{CSV}, establece las relaciones entre los objetos y realiza el ingreso de los datos al directorio.

{
\scriptsize
\linespread{1}
\begin{verbatim}
  # ldapadd -Y external ... < xNAS-base.ldif
  + users
  +   staff
  +   profesores
  +   alumnos
  + grupos
  + materias
\end{verbatim}
}

La arquitectura del subsistema de importaci\'{o}n comprende cuatro scripts que funcionan de manera similar de acuerdo a los siguientes lineamientos:

\begin{itemize}
  \item Realiza una conexi\'{o}n al directorio LDAP, a esta operaci\'{o}n se le denomina \textit{bind}.
  \item Convierte el archivo de entrada a la codificaci\'{o}n \textsc{UTF-8}.
  \item Lee cada rengl\'{o}n del archivo de entrada y verifica el contenido de cada campo contra una \textit{expresi\'{o}n regular} para identificar los renglones que no cumplan con el formato establecido.
  \item Si el rengl\'{o}n cumple con el formato, se contin\'{u}a con el pr\'{o}ximo paso, de lo contrario se guarda en una lista de renglones conflictivos que debe ser revisada manualmente y salta al siguiente rengl\'{o}n.
  \item Asigna los atributos de cada objeto LDAP de acuerdo al valor de cada campo.
  \item Establece las relaciones necesarias con otros objetos y realiza una transacci\'{o}n para insertar los datos en el directorio.
  \item Verifica que la inserci\'{o}n se haya realizado correctamente, en caso de existir alg\'{u}n error, se  realiza un rollback de las operaciones.
\end{itemize}

\diagramblock
{Diagrama de bloques de los scripts de carga}
{DiagramaScript}
{
  \psscalebox{1.0 1.0} % Change this value to rescale the drawing.
  {
    \begin{pspicture}(0,-1.9053571)(11.5,1.9053571)
    \rput[bl](0.33,1.1353571){\textbf{CSV}}
    \rput[bl](4.07,1.0803571){./script.rb}
    \rput[bl](3.295,-1.1396428){\textsl{Objetos Conflictivos}}
    \rput[bl](3.345,-1.9053571){Verificaci\'{o}n manual}
    \rput[bl](8.675,1.1353571){Directorio LDAP}
    \psframe[linecolor=black, linewidth=0.04, dimen=outer](6.1,1.8953571)(3.6,0.6153571)
    \psframe[linecolor=black, linewidth=0.04, dimen=outer](1.48,1.8953571)(0.0,0.6153571)
    \psframe[linecolor=black, linewidth=0.04, dimen=outer](6.6,-0.51964283)(3.1,-1.4996428)
    \psframe[linecolor=black, linewidth=0.04, dimen=outer](11.5,1.9053571)(8.48,0.6053571)
    \psline[linecolor=black, linewidth=0.04, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(1.5,1.2644575)(3.592381,1.2454098)
    \psline[linecolor=black, linewidth=0.04, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(6.087619,1.2553571)(8.506667,1.2553571)
    \psline[linecolor=black, linewidth=0.04, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(6.0971427,0.84988093)(7.0590477,0.84988093)(7.04,-1.0834523)(6.582857,-1.0929762)
    \psline[linecolor=black, linewidth=0.04, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(3.1161904,-1.1691667)(2.44,-1.1691667)(2.44,0.8213095)(3.6209524,0.8117857)
    \end{pspicture}
  }
}

Cada archivo de entrada \texttt{CSV} tiene varias columnas que contienen informaci\'{o}n acerca del tipo de objeto que representan, a continuaci\'{o}n se muestran las columnas que se requieren en los archivos de entrada:

{
\begin{table}[H]
\caption{Formato de los archivos \textsl{CSV}}{}
\label{tab:csv-format}
\noindent\makebox[\textwidth]{%
\begin{tabular}[c]{c|c c c c c}
%\hline
\textbf{Archivo} & \multicolumn{5}{c}{\textbf{Columnas}} \\
\hline \hline
\textit{staff.csv} & usuario & nombre & correo & curp & \\
\textit{materias.csv} & id & grupo & materia & rfc & profesor \\
\textit{profesores.csv} & rfc & nombre & mail & & \\
\textit{alumnos.csv} & cuenta & nombre & correo & asignatura & grupo \\
%\hline
\end{tabular}
} % ending of \makebox
\end{table}
}

Para la correcta ejecuci\'{o}n de los scripts es necesario instalar los paquetes \texttt{ruby} y \texttt{rubygems} y la gema de ruby que realiza la conexi\'{o}n con el directorio \textsc{LDAP}.

{
\scriptsize
\linespread{1}
\begin{verbatim}
  # aptitude install ruby rubygems ruby-json
  # gem install net-ldap
\end{verbatim}
}

Utilizando el script se inicializa cada parte por separado desde el archivo fuente en el siguiente orden:

{
\scriptsize
\linespread{1}
\begin{verbatim}
  # iconv ...
  # ./magic.rb < staff.csv
  # ./magic.rb < materias.csv
  # ./magic.rb < profesores.csv
  # ./magic.rb < alumnos.csv
\end{verbatim}
}

\textbf{\texttt{./clean.rb} - Limpia el directorio LDAP}

      \subsection {Apache httpd}

        \subsubsection {Esquema de configuraci\'{o}n}

La configuraci\'{o}n de Apache \textit{httpd} comprende tres \texttt{VirtualHost} que sirven como puntos de entrada para el acceso de s\'{o}lo lectura o lectura y escritura a los archivos almacenados en el servidor.

{
\begin{table}[H]
\caption{VirtualHost configurados en Apache HTTPD}{}
\label{tab:virtualhost}
\noindent\makebox[\textwidth]{%
\begin{tabular}[c]{c|c}
%\hline
\textbf{VirtualHost} & \textbf{Funci\'{o}n} \\
\hline \hline
\textit{xnas.local} & Acceso a los archivos por medio de \textsc{WebDAV} \\
\textit{reset.xnas.local} & Interfaz de cambio de contrase\~{n}a \\
\textit{admin.xnas.local} & Interfaz administrativa del directorio \textsc{LDAP} \\
%\hline
\end{tabular}
} % ending of \makebox
\end{table}
}

\diagramblock
{Diagrama Apache HTTPD VirtualHost}
{DiagramaVirtualHost}
{
 \psscalebox{1.0 1.0} % Change this value to rescale the drawing.
 {
  \begin{pspicture}(0,-2.2)(15.1,2.2)
  \rput[bl](1.2,1.0){xnas.local}
  \rput[bl](0.22,-0.2){reset.xnas.local}
  \rput[bl](0.0,-1.4){admin.xnas.local}
  \rput[bl](4.3,-0.2){443/tcp}
  \rput[bl](6.67,0.2){Apache}
  \rput[bl](6.72,-0.6){HTTPD}
  \rput[bl](9.5,1.0){WebDAV}
  \rput[bl](12.7,1.0){Archivos}
  \rput[bl](12.7,0.6){Carpetas}
  \rput[bl](9.79,-1.0){PHP}
  \rput[bl](12.7,-0.6){ltb (reset)}
  \rput[bl](12.7,-1.4){lam (admin)}
  \psframe[linecolor=black, linewidth=0.04, dimen=outer](15.1,2.2)(5.9,-2.2)
  \psframe[linecolor=black, linewidth=0.04, dimen=outer](8.3,1.8)(6.3,-1.8)
  \psframe[linecolor=black, linewidth=0.04, dimen=outer](11.5,0.2)(9.1,-1.8)
  \psframe[linecolor=black, linewidth=0.04, dimen=outer](11.5,1.8)(9.1,0.6)
  \psline[linecolor=black, linewidth=0.04, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(8.3,1.0)(9.1,1.0)
  \psline[linecolor=black, linewidth=0.04, linestyle=dashed, dash=0.17638889cm 0.10583334cm, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(8.3,-0.6)(9.1,-0.6)
  \psline[linecolor=black, linewidth=0.04, linestyle=dotted, dotsep=0.10583334cm, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(8.3,-1.4)(9.1,-1.4)
  \psline[linecolor=black, linewidth=0.04, linestyle=dashed, dash=0.17638889cm 0.10583334cm, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(11.5,-0.6)(12.3,-0.6)
  \psline[linecolor=black, linewidth=0.04, linestyle=dotted, dotsep=0.10583334cm, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(11.5,-1.4)(12.3,-1.4)
  \psline[linecolor=black, linewidth=0.04, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(3.1820512,0.95897436)(3.7739928,0.95897436)(4.217949,0.13846155)
  \psline[linecolor=black, linewidth=0.04, linestyle=dashed, dash=0.17638889cm 0.10583334cm, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(3.1820512,-0.2717949)(4.217949,-0.2717949)
  \psline[linecolor=black, linewidth=0.04, linestyle=dotted, dotsep=0.10583334cm, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(3.1820512,-1.2974359)(3.7739928,-1.2974359)(4.217949,-0.6820513)
  \psline[linecolor=black, linewidth=0.04, arrowsize=0.05291666666666667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(11.5,1.0)(12.3,1.0)
  \end{pspicture}
 }
}

{
\scriptsize
\linespread{1}
\begin{verbatim}
/opt/xNAS/
+ apache2
| + ports.conf
| + extra
| \ sites-available
+ app
| + lam
| | \ htdocs
| + ltb
| | \ htdocs
| \ static
+ ssl
| + certs
| \ private
\ files
  + staff
  + profesor
  \ p -> profesor

/etc/apache2
+ ports.conf
+ extra -> /opt/xNAS/apache2/extra
\ sites-available
  + default -> /opt/xNAS/apache2/sites-available/xnas.local
  + admin.xnas.local -> /opt/xNAS/apache2/sites-available/admin.xnas.local
  \ reset.xnas.local -> /opt/xNAS/apache2/sites-available/reset.xnas.local

/etc/ssl
+ certs
| + ca.thesis.tonejito.info.crt -> /opt/xNAS/ssl/certs/ca.thesis.tonejito.info.crt
| + xnas.local.crt -> /opt/xNAS/ssl/certs/xnas.local.crt
| + admin.xnas.local.crt -> /opt/xNAS/ssl/certs/admin.xnas.local.crt
| \ reset.xnas.local.crt -> /opt/xNAS/ssl/certs/reset.xnas.local.crt
\ private
  + xnas.local.key -> /opt/xNAS/ssl/private/xnas.local.key
  + admin.xnas.local.key -> /opt/xNAS/ssl/private/admin.xnas.local.key
  \ reset.xnas.local.key -> /opt/xNAS/ssl/private/reset.xnas.local.key
\end{verbatim}
}

        \subsubsection {Configuraci\'{o}n del servicio}

Se instalan los certificados \textsc{SSL} del servidor web mediante los siguientes comandos:

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # cd /etc/ssl/private
    # ln -vsf ../../../opt/xNAS/ssl/xnas.local.key
    # cd /etc/ssl/certs
    # ln -vsf ../../../opt/xNAS/ssl/ca.thesis.tonejito.info.crt
    # ln -vsf ../../../opt/xNAS/ssl/xnas.local.crt
    # c_rehash
\end{verbatim}
}

Para configurar de manera adecuada la directiva \texttt{NameVirtualHost} para los sitios por \textsc{HTTPS} se copia el archivo \texttt{ports.conf} al directorio principal de Apache \textit{httpd}.

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # cd /opt/xNAS/apache2
    # cp ports.conf /etc/apache2
    # /etc/init.d/apache2 restart
    # apache2ctl -S
\end{verbatim}
}

Se habilita el acceso a las configuraciones espec\'{i}ficas del \textit{appliance} al hacer una \textit{liga simb\'{o}lica} al directorio \texttt{extra}:

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # cd /etc/apache2
    # ln -vsf ../../opt/xNAS/apache2/extra
\end{verbatim}
}

Se instalan y habilitan los m\'{odulos} necesarios para que las funcionalidades del sitio se realizen de manera adecuada, esto incluye la autenticaci\'{o}n y la funcionalidad de \textsc{WebDAV}. Por \'{u}ltimo se reinicia el servicio para aplicar los cambios.

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # aptitude install libapache2-mod-rpaf
    # cd /etc/apache2/sites-available
    # ln -vsf ../../../opt/xNAS/apache2/xnas.local
    # a2dissite default
    # a2enmod headers ssl rewrite ldap authnz_ldap dav dav_fs dav_lock
    # a2enmod proxy proxy_http rpaf
    # a2ensite default
    # /etc/init.d/apache2 restart
\end{verbatim}
}

%\ifdraft{Configuraci\'{o}n de Apache \textsc{httpd}.}{\verbatimincludebox{./etc/apache2/apache2.conf}}

    \section {Implementaci\'{o}n de las interfaces de usuario}

      \subsection {Acceso mediante cliente nativo de \textsc{WebDAV}}

Para 

        \subsubsection{P\'{a}gina de inicio del sitio web}

Se desarroll\'{o} una p\'{a}gina para facilitar a los usuarios la b\'{u}squeda de los directorios asociados con sus materias

      \subsection {Interfaz de administraci\'{o}n \textit{LDAP Account Manager}}

Se descarga el \textit{tarball} del c\'{o}digo fuente y se descomprime en el directorio \texttt{lam/htdocs}:

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # cd /opt/xNAS/app/lam
    # wget -c 'http://iweb.dl.sourceforge.net/project/lam/LAM/4.8/ldap-account-manager-4.8.tar.bz2'
    # tar -xvvjf ldap-account-manager-4.8.tar.bz2 -C /opt/xNAS/app/lam
    # mv ldap-account-manager-4.8 htdocs
\end{verbatim}
}

Se establecen permisos de escritura para el servidor web en los directorios \texttt{sess} y \texttt{temp}:

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # chown -cR www-data:www-data /opt/xNAS/app/lam/htdocs/{sess,tmp}
\end{verbatim}
}

Se instalan los archivos de configuraci\'{o}n de la herramienta:

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # cd /opt/xNAS/app/lam/htdocs/config
    # ln -vsf ../../lam.conf
    # ln -vsf ../../config.cfg
\end{verbatim}
}

Se instala el certificado, la llave privada y la configuraci\'{o}n del sitio, una vez realizado esto, se reinicia el servicio:

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # cd /etc/ssl/private
    # ln -vsf ../../../opt/xNAS/ssl/admin.xnas.local.key
    # cd /etc/ssl/certs
    # ln -vsf ../../../opt/xNAS/ssl/admin.xnas.local.crt
    # c_rehash

    # cd /etc/apache2/sites-available
    # ln -vsf ../../../opt/xNAS/apache2/admin.xnas.local
    # a2ensite admin.xnas.local
    # /etc/init.d/apache2 reload
\end{verbatim}
}

      \subsection {Interfaz de cambio de contrase\~{n}a}

Se descarga el paquete de instalaci\'{o}n del sitio web oficial y se extrae en el directorio \texttt{ltb/htdocs}:

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # cd /opt/xNAS/app/ltb
    # wget -c 'http://tools.ltb-project.org/attachments/download/497/\ 
      ltb-project-self-service-password-0.8.tar.gz'
    # tar -xvvzf ltb-project-self-service-password-0.8.tar.gz -C /opt/xNAS/app/ltb
    # mv ltb-project-self-service-password-0.8 htdocs
\end{verbatim}
}

Se instala el certificado, la llave privada y la configuraci\'{o}n del \texttt{VirtualHost}, hecho esto se reinicia el servicio para reflejar los cambios.

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # cd /etc/ssl/private
    # ln -vsf ../../../opt/xNAS/ssl/reset.xnas.local.key
    # cd /etc/ssl/certs
    # ln -vsf ../../../opt/xNAS/ssl/reset.xnas.local.crt
    # c_rehash

    # cd /etc/apache2/sites-available
    # ln -vsf ../../../opt/xNAS/apache2/reset.xnas.local
    # a2ensite reset.xnas.local
    # /etc/init.d/apache2 reload
\end{verbatim}
}

    \section {Hardening}

      \subsection {Sistema operativo}

        \subsubsection {Actualizaciones desatendidas}

Una parte importante de la configuraci\'{o}n de seguridad de un sistema radica en la instalaci\'{o}n peri\'{o}dica de actualizaciones, al ejecutar el siguiente comando y responder \textbf{YES} en el cuadro de di\'{a}logo, se configura el sistema para descargar e instalar \emph{autom\'{a}ticamente} las actualizaciones de seguridad que sean liberadas por el fabricante del sistema operativo.

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # dpkg-reconfigure unattended-upgrades

+------------------------+ Configuring unattended-upgrades +------------------------+
|                                                                                   |
| Applying updates on a frequent basis is an important part of keeping systems      |
| secure. By default, updates need to be applied manually using package management  |
| tools. Alternatively, you can choose to have this system automatically download   |
| and install security updates.                                                     |
|                                                                                   |
| Automatically download and install stable updates?                                |
|                       <Yes>                          <No>                         |
+-----------------------------------------------------------------------------------+
\end{verbatim}
}

        \subsubsection {Firewall}

Para filtrar el tr\'{a}fico de red se establecieron las siguientes pol\'{i}ticas de \textit{firewall} de host en el equipo:

\begin{itemize}
  \item Se permite todo el tr\'{a}fico proveniente de la interfaz \textit{loopback}.
  \item Las conexiones a trav\'{e}s de \textsc{SSH} se permiten \'{u}nicamente desde los siguientes segmentos confiables de red:
  \begin{enumerate}
    \item Segmentos de \textsc{RedUNAM}: \texttt{132.247.0.0/16} , \texttt{132.248.0.0/16}
    \item Red interna de la \textsc{DICyG}.
  \end{enumerate}
  \item Se permiten las conexiones por \textsc{HTTPS} desde cualquier host, ya sea de la red interna, segmentos de \textsc{RedUNAM} o Internet.
  \item Las conexiones al demonio de \textsc{LDAP} se permiten \'{u}nicamente desde \textit{localhost}.
\end{itemize}

\diagramblock
{Trusted Networks}
{TrustedNetworks}
{
 \psscalebox{1.0 1.0} % Change this value to rescale the drawing.
 {
 \begin{pspicture}(0,-1.84)(3.68,1.84)
 \rput[bl](1.225,1.48){Internet}
 \rput[bl](0.89,0.46){\textsc{RedUNAM}}
 \rput[bl](1.23,-0.76){\textsc{DICyG}}
 \pscircle[linecolor=black, linewidth=0.04, dimen=outer](1.84,-0.58){0.78}
 \pscircle[linecolor=black, linewidth=0.04, dimen=outer](1.84,-0.19){1.45}
 \psframe[linecolor=black, linewidth=0.04, dimen=outer](3.68,1.84)(0.0,-1.84)
 \end{pspicture}
 }
}

Para implementar las reglas de firewall se utiliz\'{o} \textit{iptables}, el software est\'{a}ndar para filtrado de paquetes en \textsc{GNU/Linux} y el paquete \textit{iptables-persistent} que sirve para aplicar las reglas guardadas en cada inicio del sistema operativo. El programa se instala con \textit{aptitude} y al configurarlo pregunta si se guardar\'{a}n las reglas de \textsc{IPv4} e \textsc{IPv6}.

{
\scriptsize
\linespread{1}
\begin{verbatim}
    # aptitude install iptables-persistent

+--------------------| Configuring iptables-persistent |--------------------+
|                                                                           |
| Current iptables rules can be saved to the configuration file             |
| /etc/iptables/rules.v4. These rules will then be loaded automatically     |
| during system startup.                                                    |
|                                                                           |
| Rules are only saved automatically during package installation. See the   |
| manual page of iptables-save(8) for instructions on keeping the rules     |
| file up-to-date.                                                          |
|                                                                           |
| Save current IPv4 rules?                                                  |
|                                                                           |
|                    <Yes>                       <No>                       |
|                                                                           |
+---------------------------------------------------------------------------+
\end{verbatim}
}

      \subsection {Servicios de red}

Restricci\'{o}n de acceso

        \subsubsection {ssh}

\begin{itemize}
  \item Se permite el acceso \'{u}nicamente al grupo de usuarios pertenecientes al staff de la DICyG
\end{itemize}

        \subsubsection {http}

\begin{itemize}
  \item Se restringe el acceso a cada \texttt{VirtualHost} desde determinado rango de direcciones IP
\end{itemize}

        \subsubsection {ldap}

\begin{itemize}
  \item Se permiten conexiones locales por \texttt{socket} \texttt{ldapi:///} y conexiones al puerto 389 para diagn\'{o}stico
\end{itemize}

